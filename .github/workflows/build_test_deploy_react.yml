name: Build, Test and Deploy React Application

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ============================================================
  # Job 1 : Build ‚Üí Test ‚Üí Coverage ‚Üí JSDoc ‚Üí Artifact
  # ============================================================
  build_test:
    name: Build and Test
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    defaults:
      run:
        working-directory: my-app

    permissions:
      contents: read

    env:
      REACT_APP_API_URL: https://jsonplaceholder.typicode.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: my-app/package-lock.json

      - name: Installation des d√©pendances
        run: npm ci

      - name: Linting
        run: npm run lint

      - name: Generate JSDoc (dans public/docs avant le build)
        run: npm run jsdoc

      - name: Build application React (inclut public/docs ‚Üí build/docs)
        run: npm run build

      - name: Tests Unitaires et Int√©gration (avec couverture)
        run: npm test -- --watchAll=false --runInBand --coverage

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v4
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        with:
          directory: my-app/coverage
          fail_ci_if_error: false

      - name: Upload rapport de couverture (artefact)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: my-app/coverage/
          if-no-files-found: warn

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Upload artifact (app + docs)
        uses: actions/upload-pages-artifact@v3
        with:
          path: my-app/build

  # ============================================================
  # Job 2 : Tests E2E (Cypress) ‚Äî n√©cessite build_test OK
  # ============================================================
  e2e:
    name: Tests E2E (Cypress)
    runs-on: ubuntu-latest
    needs: build_test

    env:
      REACT_APP_API_URL: https://jsonplaceholder.typicode.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cypress run
        uses: cypress-io/github-action@v6
        with:
          working-directory: my-app
          start: npm start
          wait-on: 'http://localhost:3000'
          wait-on-timeout: 60
        env:
          PUBLIC_URL: /
          BROWSER: none
          REACT_APP_API_URL: https://jsonplaceholder.typicode.com

      - name: Upload screenshots en cas d'√©chec
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: my-app/cypress/screenshots
          if-no-files-found: ignore

  # ============================================================
  # Job 3 : Publication sur npm ‚Äî n√©cessite build_test OK
  # Logique de bypass : publie uniquement si version locale > version npm
  # ============================================================
  publish-npm:
    name: Publish to NPM üì¶
    runs-on: ubuntu-latest
    needs: build_test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    defaults:
      run:
        working-directory: my-app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js with npm registry
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'
          cache-dependency-path: my-app/package-lock.json

      - name: Installation des d√©pendances
        run: npm ci

      - name: V√©rifier si la version doit √™tre publi√©e (bypass)
        id: version-check
        run: |
          LOCAL_VERSION=$(node -p "require('./package.json').version")
          NPM_VERSION=$(npm view ynov-inscription-form version 2>/dev/null || echo "0.0.0")
          echo "Version locale : $LOCAL_VERSION"
          echo "Version publi√©e sur npm : $NPM_VERSION"
          IS_GREATER=$(node -e "
            const toArr = v => v.split('.').map(Number);
            const [la, lb, lc] = toArr('$LOCAL_VERSION');
            const [pa, pb, pc] = toArr('$NPM_VERSION');
            const gt = la > pa || (la === pa && lb > pb) || (la === pa && lb === pb && lc > pc);
            console.log(gt ? 'true' : 'false');
          ")
          echo "should_publish=$IS_GREATER" >> $GITHUB_OUTPUT
          if [ "$IS_GREATER" = "true" ]; then
            echo "‚úÖ Nouvelle version d√©tect√©e ($LOCAL_VERSION > $NPM_VERSION) ‚Äî publication en cours."
          else
            echo "‚è≠Ô∏è Aucune nouvelle version ($LOCAL_VERSION = $NPM_VERSION) ‚Äî publication ignor√©e."
          fi

      - name: Build du package npm
        if: steps.version-check.outputs.should_publish == 'true'
        run: npm run build-npm

      - name: Publier sur npm
        if: steps.version-check.outputs.should_publish == 'true'
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ============================================================
  # Job 4 : D√©ploiement GitHub Pages ‚Äî n√©cessite publish-npm OK
  # (s'ex√©cute m√™me si publish-npm a √©t√© ignor√©)
  # ============================================================
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: publish-npm
    if: ${{ always() && needs.publish-npm.result != 'failure' }}

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    permissions:
      pages: write
      id-token: write

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
